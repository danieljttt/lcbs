
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LCBS Fantasy league </title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
<header>
  <div class="container row">
    <div class="h1">LCBS Fantasy league <span class="pill" id="ver">v6</span></div>
    <div class="right row" id="authBox">
      <input id="uName" placeholder="–ª–æ–≥–∏–Ω" />
      <input id="uPass" placeholder="–ø–∞—Ä–æ–ª—å" type="password" />
      <button id="btnReg" class="ghost">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      <button id="btnLogin" class="primary">–í–æ–π—Ç–∏</button>
    </div>
    <div class="right row hide" id="userBox">
      <span id="userLabel" class="pill"></span>
      <span id="userBalance" class="pill">–±–∞–ª–∞–Ω—Å: 0</span>
      <button id="btnLogout" class="ghost">–í—ã–π—Ç–∏</button>
    </div>
  </div>
</header>

<div class="container content">
  <!-- TABS CONTENT -->
  <section id="tab-home">
    <div class="card">
      <h3>–ú–∞—Ç—á–∏</h3>
      <div id="matches"></div>
    </div>
    <div class="card hide" id="adminPanel">
      <h3>–ê–¥–º–∏–Ω–∫–∞</h3>
      <div class="row">
        <input id="teamA" placeholder="–ö–æ–º–∞–Ω–¥–∞ A" />
        <input id="teamB" placeholder="–ö–æ–º–∞–Ω–¥–∞ B" />
        <button id="btnCreateMatch" class="primary">+ –ú–∞—Ç—á</button>
        <div class="right pill" id="adminBalance">admin: 0</div>
      </div>
      <div class="hr"></div>
      <div id="adminMatches"></div>
    </div>
  </section>

  <section id="tab-fantasy" class="hide">
    <div class="card">
      <div class="row">
        <h3>–§—ç–Ω—Ç–µ–∑–∏ –õ–∏–≥–∞</h3>
        <div class="right row">
          <button class="ghost" id="btnFantasyMy">–ú–æ—è –∫–æ–º–∞–Ω–¥–∞</button>
          <button class="primary" id="btnFantasyLeaders">–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</button>
        </div>
      </div>
    </div>

    <div id="fantasy-my" class="card">
      <h4>–°–æ–±–µ—Ä–∏ –∫–æ–º–∞–Ω–¥—É (1 –∏–≥—Ä–æ–∫ –∏–∑ –∫–∞–∂–¥–æ–≥–æ —Ç–∏—Ä–∞)</h4>
      <div id="tiers" class="grid3"></div>
      <div class="row" style="margin-top:10px">
        <button id="btnSaveFantasy" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É</button>
        <small id="fantasySaved" class="muted"></small>
      </div>
    </div>

    <div id="fantasy-leaders" class="card hide">
      <h4>–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h4>
      <div id="leadersTable"></div>
    </div>

    <div class="card hide" id="fantasyAdmin">
      <h4>–ê–¥–º–∏–Ω: –æ—á–∫–∏ –∏–≥—Ä–æ–∫–æ–≤</h4>
      <small>–í—ã–±–µ—Ä–∏ –∏–≥—Ä–æ–∫–∞ –∏ –ø—Ä–∏–±–∞–≤—å/—É–±–∞–≤—å –æ—á–∫–∏. –õ–∏–¥–µ—Ä–±–æ—Ä–¥ –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</small>
      <div class="row" style="margin-top:8px">
        <select id="scorePlayer"></select>
        <input id="scoreDelta" type="number" placeholder="Œî –æ—á–∫–æ–≤" />
        <button id="btnScoreApply" class="ghost">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
    </div>
  </section>

  <section id="tab-profile" class="hide">
    <div class="card">
      <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
      <div id="profileBox" class="muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–∞–Ω–Ω—ã–µ</div>
    </div>
  </section>
</div>

<!-- bottom navbar -->
<nav class="navbar">
  <div class="inner">
    <a class="tabbtn active" data-tab="home"><span class="icon">üè†</span><span>–ú–∞—Ç—á–∏</span></a>
    <a class="tabbtn" data-tab="fantasy"><span class="icon">üèÜ</span><span>Fantasy</span></a>
    <a class="tabbtn" data-tab="profile"><span class="icon">üë§</span><span>–ü—Ä–æ—Ñ–∏–ª—å</span></a>
  </div>
</nav>

<script type="module">
import {
  getCurrentUser, registerUser, loginUser, logoutUser,
  loadTeams, addTeam,
  loadMatchesDB, createMatchDB, setWinnerDB, placeBetDB,
  getUserBalance, getAdminBalance, subscribeRealtime,
  // fantasy
  loadFantasyPlayers, saveFantasyTeam, loadMyFantasyTeam, loadFantasyTeams, addPlayerPoints
} from './firebase.js';

/* ===== helpers ===== */
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
const fmt = n=> Math.round(Number(n||0));

/* ===== tabs ===== */
function showTab(name){
  $('#tab-home').classList.toggle('hide', name!=='home');
  $('#tab-fantasy').classList.toggle('hide', name!=='fantasy');
  $('#tab-profile').classList.toggle('hide', name!=='profile');
  $$('.tabbtn').forEach(b=> b.classList.toggle('active', b.dataset.tab===name));
}
$$('.tabbtn').forEach(b=> b.addEventListener('click', ()=> showTab(b.dataset.tab)));

/* ===== auth ===== */
function refreshAuthUI(){
  const u = getCurrentUser();
  $('#authBox').classList.toggle('hide', !!u);
  $('#userBox').classList.toggle('hide', !u);
  if(u){ $('#userLabel').textContent = u.username; }
  // admin-only blocks
  const isAdmin = u && u.username === 'dturannn';
  $('#adminPanel').classList.toggle('hide', !isAdmin);
  $('#fantasyAdmin').classList.toggle('hide', !isAdmin);
}
async function refreshBalances(){
  const u = getCurrentUser();
  if(u){
    const bal = await getUserBalance(u.id);
    $('#userBalance').textContent = '–±–∞–ª–∞–Ω—Å: '+fmt(bal);
  }
  const ab = await getAdminBalance();
  $('#adminBalance').textContent = 'admin: '+fmt(ab);
}
$('#btnReg').onclick = async ()=>{
  const u=$('#uName').value.trim(), p=$('#uPass').value.trim();
  if(!u||!p) return alert('–ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å?');
  const ok = await registerUser(u,p);
  if(ok){ refreshAuthUI(); refreshBalances(); renderAll(); }
};
$('#btnLogin').onclick = async ()=>{
  const u=$('#uName').value.trim(), p=$('#uPass').value.trim();
  const me = await loginUser(u,p);
  if(me){ refreshAuthUI(); refreshBalances(); renderAll(); }
};
$('#btnLogout').onclick = ()=>{ logoutUser(); refreshAuthUI(); renderAll(); };

/* ===== matches ===== */
function matchCard(m){
  const total = (m.betsA||0)+(m.betsB||0);
  const pA = total>0 ? Math.round((m.betsA||0)/total*100) : 0;
  const pB = total>0 ? 100 - pA : 0;
  const glowA = (!m.open && m.winner==='A') ? 'winner-glow winner' : '';
  const glowB = (!m.open && m.winner==='B') ? 'winner-glow winner' : '';
  return `<div class="card" data-match-id="${m.id}" data-winner="${m.winner||''}">
    <div class="pikachu"></div>
    <div class="grid2">
      <div class="${glowA}">
        <div class="center"><span class="name">A: ${m.A}</span><span class="pill">${pA}%</span></div>
        ${m.open?`<button data-bet="A" data-id="${m.id}" class="ghost">–°—Ç–∞–≤–∫–∞ –Ω–∞ A</button>`:`<small class="muted">–ú–∞—Ç—á –∑–∞–∫—Ä—ã—Ç</small>`}
      </div>
      <div class="${glowB}">
        <div class="center"><span class="name">B: ${m.B}</span><span class="pill">${pB}%</span></div>
        ${m.open?`<button data-bet="B" data-id="${m.id}" class="ghost">–°—Ç–∞–≤–∫–∞ –Ω–∞ B</button>`:`<small class="muted">–ú–∞—Ç—á –∑–∞–∫—Ä—ã—Ç</small>`}
      </div>
    </div>
    <div class="hr"></div>
    <small class="muted">–°—Ç–∞–≤–∫–∏: A=${fmt(m.betsA)} | B=${fmt(m.betsB)}</small>
  </div>`;
}
async function renderMatches(){
  const ms = await loadMatchesDB();
  $('#matches').innerHTML = ms.map(matchCard).join('') || '<div class="card muted">–ù–µ—Ç –º–∞—Ç—á–µ–π</div>';
  $('#matches').querySelectorAll('button[data-bet]').forEach(btn=>{
    btn.onclick = async ()=>{
      const me = getCurrentUser(); if(!me) return alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ');
      const side = btn.dataset.bet, id = btn.dataset.id;
      const bal = await getUserBalance(me.id);
      const amt = parseFloat(prompt(`–°—É–º–º–∞ (–±–∞–ª–∞–Ω—Å ${fmt(bal)})`,'10')||'0');
      if(!(amt>0)) return; if(bal < amt) return alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
      await placeBetDB(me.id, id, side, amt);
      refreshBalances();
    };
  });
}
async function renderAdminMatches(){
  const u = getCurrentUser(); const isAdmin = u && u.username==='dturannn';
  if(!isAdmin) return;
  const ms = await loadMatchesDB();
  $('#adminMatches').innerHTML = ms.map(m=>`
    <div class="card">
      <div class="row">
        <div>A: <b>${m.A}</b> <span class="pill">${fmt((m.betsA||0)/((m.betsA||0)+(m.betsB||0) || 1)*100)}%</span></div>
        <div>B: <b>${m.B}</b> <span class="pill">${fmt((m.betsB||0)/((m.betsA||0)+(m.betsB||0) || 1)*100)}%</span></div>
        <div class="right muted">${m.open?'–æ—Ç–∫—Ä—ã—Ç':('–∑–∞–∫—Ä—ã—Ç: '+(m.winner||''))}</div>
      </div>
      ${m.open?`<div class="row" style="margin-top:8px">
        <button class="ghost" data-win="A" data-id="${m.id}">–ü–æ–±–µ–¥–∞ A</button>
        <button class="ghost" data-win="B" data-id="${m.id}">–ü–æ–±–µ–¥–∞ B</button>
      </div>`:''}
    </div>`).join('') || '<small class="muted">–ù–µ—Ç –º–∞—Ç—á–µ–π</small>';
  $('#adminMatches').querySelectorAll('button[data-win]').forEach(b=>{
    b.onclick = async ()=>{
      const id=b.dataset.id, side=b.dataset.win;
      if(!confirm('–ó–∞–∫—Ä—ã—Ç—å –º–∞—Ç—á –∏ –≤—ã–±—Ä–∞—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è '+side+'?')) return;
      await setWinnerDB(id, side);
      refreshBalances();
    };
  });
}
$('#btnCreateMatch').onclick = async ()=>{
  const A=$('#teamA').value.trim(), B=$('#teamB').value.trim();
  if(!A||!B||A===B) return alert('–£–∫–∞–∂–∏ —Ä–∞–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã');
  await createMatchDB({A,B,deadline:0});
  $('#teamA').value=''; $('#teamB').value='';
};

/* ===== fantasy ===== */
let fantasyPlayers = [];
function renderTierPickers(){
  const tiersEl = $('#tiers');
  const tiers = [1,2,3].map(t => ({
    t,
    list: fantasyPlayers.filter(p => Number(p.tier)===t)
  }));
  tiersEl.innerHTML = tiers.map(T=>{
    const opts = T.list.map(p => `<option value="${p.id}">${p.name} ‚Äî ${p.team} (${p.points||0} –æ—á–∫.)</option>`).join('');
    return `<div class="card">
      <h4>Tier ${T.t}</h4>
      <select id="pick${T.t}"><option value="">‚Äî –í—ã–±—Ä–∞—Ç—å –∏–≥—Ä–æ–∫–∞ ‚Äî</option>${opts}</select>
    </div>`;
  }).join('');
}
function renderLeadersTable(teams){
  const rows = teams.sort((a,b)=> (b.total_points||0)-(a.total_points||0)).map((t,i)=>{
    const p1 = fantasyPlayers.find(p=>p.id===t.tier1)?.name || '-';
    const p2 = fantasyPlayers.find(p=>p.id===t.tier2)?.name || '-';
    const p3 = fantasyPlayers.find(p=>p.id===t.tier3)?.name || '-';
    return `<tr>
      <td>${i+1}</td><td>${t.manager}</td><td>${p1}</td><td>${p2}</td><td>${p3}</td><td>${fmt(t.total_points)}</td>
    </tr>`;
  }).join('');
  $('#leadersTable').innerHTML = `<table>
    <thead><tr><th>#</th><th>–ú–µ–Ω–µ–¥–∂–µ—Ä</th><th>Tier1</th><th>Tier2</th><th>Tier3</th><th>–û—á–∫–∏</th></tr></thead>
    <tbody>${rows || '<tr><td colspan="6"><small class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</small></td></tr>'}</tbody>
  </table>`;
}
$('#btnFantasyMy').onclick = ()=>{
  $('#fantasy-my').classList.remove('hide');
  $('#fantasy-leaders').classList.add('hide');
};
$('#btnFantasyLeaders').onclick = ()=>{
  $('#fantasy-my').classList.add('hide');
  $('#fantasy-leaders').classList.remove('hide');
};
$('#btnSaveFantasy').onclick = async ()=>{
  const u=getCurrentUser(); if(!u) return alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ');
  const t1=$('#pick1')?.value||'', t2=$('#pick2')?.value||'', t3=$('#pick3')?.value||'';
  if(!t1||!t2||!t3) return alert('–ù—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –ø–æ –∏–≥—Ä–æ–∫—É –∏–∑ –∫–∞–∂–¥–æ–≥–æ —Ç–∏—Ä–∞');
  await saveFantasyTeam(u.username, {tier1:t1,tier2:t2,tier3:t3});
  $('#fantasySaved').textContent='–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!';
};

/* ===== profile ===== */
async function renderProfile(){
  const u=getCurrentUser();
  if(!u){ $('#profileBox').textContent='–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–∞–Ω–Ω—ã–µ'; return; }
  const bal=await getUserBalance(u.id);
  $('#profileBox').innerHTML = `<b>${u.username}</b><br/>–ë–∞–ª–∞–Ω—Å: ${fmt(bal)}`;
}

/* ===== full render ===== */
async function renderFantasy(){
  fantasyPlayers = await loadFantasyPlayers();
  renderTierPickers();
  const u=getCurrentUser();
  if(u){
    const mine = await loadMyFantasyTeam(u.username);
    if(mine){
      if($('#pick1')) $('#pick1').value = mine.tier1||'';
      if($('#pick2')) $('#pick2').value = mine.tier2||'';
      if($('#pick3')) $('#pick3').value = mine.tier3||'';
    }
  }
  const teams = await loadFantasyTeams();
  renderLeadersTable(teams);
}
async function renderAll(){
  refreshAuthUI();
  await renderMatches();
  await renderAdminMatches();
  await renderFantasy();
  await renderProfile();
  await refreshBalances();
}

/* realtime */
subscribeRealtime(()=> renderAll());

/* go */
renderAll();
</script>
</body>
</html>
