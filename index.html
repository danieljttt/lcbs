<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>LCBS Fantasy</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<header class="row">
  <button class="tabbtn active" data-tab="home">–ì–ª–∞–≤–Ω–∞—è</button>
  <button class="tabbtn" data-tab="fantasy">–§—ç–Ω—Ç–µ–∑–∏</button>
  <button class="tabbtn" data-tab="profile">–ü—Ä–æ—Ñ–∏–ª—å</button>
  <div style="flex:1"></div>
  <span id="userLabel" class="badge">–≥–æ—Å—Ç—å</span>
</header>

<div id="tab-home" class="container">
  <h2>LCBS Fantasy ‚Äî –¥–µ–º–æ</h2>
  <p class="muted small">–ü—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞ GitHub Pages + Firebase Realtime Database.</p>
  <div class="section card">
    <div class="row">
      <input id="uName" placeholder="–ª–æ–≥–∏–Ω">
      <input id="uPass" placeholder="–ø–∞—Ä–æ–ª—å" type="password">
      <button id="btnReg">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      <button id="btnLogin">–í–æ–π—Ç–∏</button>
      <button id="btnLogout" class="hide">–í—ã–π—Ç–∏</button>
    </div>
    <div class="row small" style="margin-top:8px">
      <span>–±–∞–ª–∞–Ω—Å —Å—Ç–∞–≤–∫–∏: <b id="userBalanceBets">0</b></span>
      <span> ‚Ä¢ </span>
      <span>–±–∞–ª–∞–Ω—Å fantasy: <b id="userBalanceFantasy">0</b></span>
    </div>
  </div>

  <div id="adminPanel" class="card hide">
    <h2>–ê–¥–º–∏–Ω–∫–∞</h2>
    <div class="section">
      <h3>–ö–æ–º–∞–Ω–¥—ã ‚Äî –ª–æ–≥–æ</h3>
      <div class="row">
        <select id="teamSelect"></select>
        <input id="teamLogoUrl" placeholder="URL –ª–æ–≥–æ—Ç–∏–ø–∞">
        <button id="saveTeamLogo">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>

    <div class="section">
      <h3>–ò–≥—Ä–æ–∫–∏ ‚Äî –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3>
      <div class="row">
        <select id="playerSelect"></select>
        <input id="playerPoints" type="number" placeholder="–û—á–∫–∏">
        <input id="playerAchievements" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π">
        <button id="savePlayerStats">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>

    <div class="section">
      <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ‚Äî –±–∞–ª–∞–Ω—Å—ã</h3>
      <button id="refreshUsersList">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
      <div id="usersList"></div>
    </div>
  </div>
</div>

<div id="tab-fantasy" class="container hide">
  <h2>–ú–æ—è –∫–æ–º–∞–Ω–¥–∞</h2>
  <div id="myTeamBox" class="grid"></div>
  <h2>–í—Å–µ –∏–≥—Ä–æ–∫–∏</h2>
  <div id="allPlayersBox" class="grid"></div>
</div>

<div id="tab-profile" class="container hide">
  <div class="card">
    <div class="row">
      <span class="muted small">ID:</span>
      <span id="meId" class="small">‚Äî</span>
    </div>
  </div>
</div>

<script type="module" src="firebase.js"></script>
<script type="module">
import { database, getCurrentUser, registerUser, loginUser, logoutUser, getUserBalances, getAdminBalance, 
         getFantasyPlayers, getUserFantasyPlayers, buyFantasyPlayer,
         getTeams, updateTeamLogo, updatePlayerStats, getAllUsers, updateUserBalances } from './firebase.js';

const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const fmt = n => (n||0).toLocaleString('ru-RU');

function showTab(name){
  $('#tab-home').classList.toggle('hide', name!=='home');
  $('#tab-fantasy').classList.toggle('hide', name!=='fantasy');
  $('#tab-profile').classList.toggle('hide', name!=='profile');
  $$('.tabbtn').forEach(b=> b.classList.toggle('active', b.dataset.tab===name));
}
$$('.tabbtn').forEach(b => b.addEventListener('click', () => showTab(b.dataset.tab)));

function refreshAuthUI(){
  const u = getCurrentUser();
  $('#btnLogout').classList.toggle('hide', !u);
  $('#userLabel').textContent = u ? u.username : '–≥–æ—Å—Ç—å';
  const isAdmin = u && u.username==='dturannn';
  $('#adminPanel').classList.toggle('hide', !isAdmin);
}
async function refreshBalances(){
  const u=getCurrentUser(); if(!u) return;
  const b=await getUserBalances(u.id);
  $('#userBalanceBets').textContent = fmt(b.balanceBets);
  $('#userBalanceFantasy').textContent = fmt(b.balanceFantasy);
  $('#meId').textContent = u.id;
}

$('#btnReg').onclick = async () => {
  const u=$('#uName').value.trim(), p=$('#uPass').value.trim();
  if(!u||!p) return alert('–ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å?');
  const ok = await registerUser(u,p);
  if(ok){ refreshAuthUI(); await refreshBalances(); await renderFantasyTab(); }
};
$('#btnLogin').onclick = async () => {
  const u=$('#uName').value.trim(), p=$('#uPass').value.trim();
  const me = await loginUser(u,p);
  if(me){ refreshAuthUI(); await refreshBalances(); await renderFantasyTab(); }
};
$('#btnLogout').onclick = async () => { await logoutUser(); refreshAuthUI(); };

async function renderFantasyTab() {
  const me = getCurrentUser(); if(!me) return;
  const [allPlayers, myPlayers] = await Promise.all([getFantasyPlayers(), getUserFantasyPlayers(me.id)]);
  const myIds = new Set(myPlayers.map(p=>p.id));
  const myBox=$('#myTeamBox'); myBox.innerHTML='';
  myPlayers.forEach(p => myBox.innerHTML += cardHTML(p, true));

  const allBox=$('#allPlayersBox'); allBox.innerHTML='';
  allPlayers.forEach(p => {
    const owned = myIds.has(p.id);
    allBox.innerHTML += cardHTML(p, owned);
  });
  document.querySelectorAll('.buyBtn').forEach(btn => btn.addEventListener('click', async () => {
    await buyFantasyPlayer(me.id, btn.dataset.id);
    await refreshBalances();
    renderFantasyTab();
  }));
}
function cardHTML(p, owned){
  const logo = p.logo || p.teamLogo || 'https://picsum.photos/400/220?blur=2';
  const pts = (p.stats && p.stats.points) ? p.stats.points : 0;
  const ach = (p.stats && p.stats.achievements) ? p.stats.achievements : '';
  return `<div class="card">
    <img src="${logo}" alt="${p.name}">
    <div class="title">${p.name}</div>
    <div class="muted small">–û—á–∫–∏: ${pts}</div>
    ${ach? `<div class="small">${ach}</div>`:''}
    ${owned ? `<div class="badge">–í —Å–æ—Å—Ç–∞–≤–µ</div>` : `<button class="buyBtn" data-id="${p.id}">–ö—É–ø–∏—Ç—å</button>`}
  </div>`;
}

async function hydrateAdmin() {
  const [teams, players] = await Promise.all([getTeams(), getFantasyPlayers()]);
  const tSel = $('#teamSelect'); tSel.innerHTML = Object.values(teams).map(t=>`<option value="${t.id}">${t.name}</option>`).join('');
  const pSel = $('#playerSelect'); pSel.innerHTML = players.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
}
$('#saveTeamLogo').addEventListener('click', async () => {
  const id = $('#teamSelect').value, url=$('#teamLogoUrl').value.trim();
  if(!id||!url) return;
  await updateTeamLogo(id, url);
  alert('–õ–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
  await hydrateAdmin(); await renderFantasyTab();
});
$('#savePlayerStats').addEventListener('click', async () => {
  const id=$('#playerSelect').value, pts=parseInt($('#playerPoints').value)||0, ach=$('#playerAchievements').value.trim();
  await updatePlayerStats(id, { points: pts, achievements: ach });
  alert('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
  await renderFantasyTab();
});

async function renderUsersList(){
  const list = await getAllUsers();
  const box = $('#usersList'); box.innerHTML = '';
  list.forEach(u => {
    const bets = u.balances?.balanceBets ?? 0;
    const fan = u.balances?.balanceFantasy ?? 0;
    const id = u.id;
    box.innerHTML += `<div class="card">
      <div><b>${u.username}</b> <span class="muted small">(${id})</span></div>
      <div class="row" style="margin-top:6px">
        <label class="small">–°—Ç–∞–≤–∫–∏: <input id="bets-${id}" type="number" value="${bets}"></label>
        <label class="small">Fantasy: <input id="fan-${id}" type="number" value="${fan}"></label>
        <button class="saveUserBtn" data-id="${id}">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>`;
  });
  document.querySelectorAll('.saveUserBtn').forEach(btn => btn.addEventListener('click', async () => {
    const id = btn.dataset.id;
    const newBets = parseFloat(document.querySelector('#bets-'+id).value)||0;
    const newFan  = parseFloat(document.querySelector('#fan-'+id).value)||0;
    await updateUserBalances(id, { balanceBets: newBets, balanceFantasy: newFan });
    alert('–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—ë–Ω');
    await refreshBalances();
  }));
}
document.querySelector('#refreshUsersList').addEventListener('click', renderUsersList);

refreshAuthUI(); hydrateAdmin(); renderFantasyTab();
</script>
</body>
</html>
