<!DOCTYPE html>
<html lang="lv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fantasy Likmes ‚Äî v5_9 + Supabase Auth</title>
<style>
body{font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0e0e0e; color:#eaeaea; margin:0}
.container{max-width:1100px;margin:0 auto;padding:14px}
.card{background:#141414;border:1px solid #2a2a2a;border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
h1{margin:0 0 8px;font-size:20px}h2{margin:0 0 8px;font-size:18px}h3{margin:0 0 6px;font-size:16px}
input,select{background:#0f0f0f;border:1px solid #2f2f2f;color:#eaeaea;border-radius:12px;padding:10px}
button{background:linear-gradient(180deg,#1f1f1f,#0f0f0f);border:1px solid #2f2f2f;color:#eaeaea;border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:700}
button:hover{box-shadow:0 0 0 3px rgba(127,212,135,.15)}
.badge{display:inline-flex;align-items:center;gap:6px;border:1px solid #2f2f2f;border-radius:999px;padding:6px 10px;background:#111}
.muted{color:#9aa0a6}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table td,.table th{padding:10px 8px;background:#161616;border-top:1px solid #2a2a2a;border-bottom:1px solid #2a2a2a}
.table tr td:first-child{border-left:1px solid #2a2a2a;border-top-left-radius:10px;border-bottom-left-radius:10px}
.table tr td:last-child{border-right:1px solid #2a2a2a;border-top-right-radius:10px;border-bottom-right-radius:10px}
.center{text-align:center}

/* Match cards */
.bet-card{border-radius:20px;padding:16px;border:1px solid #2a2a2a;background:#151515;position:relative;margin-bottom:12px}
.bet-grid{display:grid;grid-template-columns:1fr auto 1fr;gap:14px;align-items:center}
.bet-team{display:flex;flex-direction:column;align-items:center;gap:8px;position:relative;border:2px solid #333;border-radius:12px;padding:10px}
.bet-vs{font-weight:900;color:#9aa0a6}
.win-label{font-weight:800;margin-top:2px}
.match-closed{font-weight:700}

/* Rainbow neon winner glow */
.win-glow{
  border:2px solid #00ff88 !important;
  animation:rainbowGlow 3.2s linear infinite, pulseGlow 1.4s ease-in-out infinite;
  box-shadow:0 0 14px #00ff88, 0 0 28px #00ff88, inset 0 0 10px rgba(0,255,136,.45);
}
@keyframes rainbowGlow{
  0%{ box-shadow:0 0 14px #00ff88,0 0 28px #00ff88,inset 0 0 10px rgba(0,255,136,.45); border-color:#00ff88;}
  33%{ box-shadow:0 0 14px #ffaa00,0 0 28px #ffaa00,inset 0 0 10px rgba(255,170,0,.45); border-color:#ffaa00;}
  66%{ box-shadow:0 0 14px #0099ff,0 0 28px #0099ff,inset 0 0 10px rgba(0,153,255,.45); border-color:#0099ff;}
  100%{ box-shadow:0 0 14px #00ff88,0 0 28px #00ff88,inset 0 0 10px rgba(0,255,136,.45); border-color:#00ff88;}
}
@keyframes pulseGlow{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}

/* Pikachu badge (above winner) */
.pikachu-flag{position:absolute;top:-10px;left:50%;transform:translate(-50%,-100%);width:44px;height:44px;animation:badgePulse 1.6s ease-in-out infinite;filter:drop-shadow(0 2px 2px rgba(0,0,0,.25))}
@keyframes badgePulse{0%,100%{transform:translate(-50%,-100%) scale(1)}50%{transform:translate(-50%,-102%) scale(1.05)}}

.section{margin-bottom:14px}
</style>
</head>
<body>
<div class="container">
  <div class="card section">
    <h1>Fantasy Likmes ‚Äî v5_9 + Supabase</h1>
    <div class="row" id="authRow">
      <input id="authUser" placeholder="LietotƒÅjvƒÅrds" style="min-width:200px">
      <input id="authPass" placeholder="Parole" type="password" style="min-width:200px">
      <button onclick="doRegister()">Reƒ£istrƒìties</button>
      <button onclick="doLogin()">Ieiet</button>
      <button onclick="doLogout()">Iziet</button>
      <span class="badge" id="whoami">‚Äî</span>
      <span class="badge">Bilance: <b id="balance">‚Äî</b> kr</span>
    </div>
  </div>

  <div class="card section">
    <h2>Admin panelis</h2>
    <div class="row">
      <input id="teamA" placeholder="Komanda A">
      <input id="teamB" placeholder="Komanda B">
      <button onclick="createMatch()">Izveidot maƒçu</button>
    </div>
    <p class="muted">* Admin ‚Äî lietotƒÅjs ar lietotƒÅjvƒÅrdu <b>dturannn</b>.</p>
  </div>

  <div class="card section">
    <h2>Likmes</h2>
    <div id="betCards"></div>
  </div>

  <div class="card section">
    <h2>Manas likmes</h2>
    <div id="myBets"></div>
  </div>
</div>

<script type="module">
import {
  supabase,
  registerUser,
  loginUser,
  getCurrentUser,
  logoutUser,
  loadMatchesDB,
  createMatchDB,
  setWinnerDB,
  placeBetDB,
  getUserBalance,
  getUserByUsername,
  getUserBets
} from './supabase.js';

function pikachuSVG(){
  return `<svg class="pikachu-flag" viewBox="0 0 64 64" aria-hidden="true">
    <path d="M44 8 l14 6 -14 6 -14 -6 z" fill="#222"/>
    <path d="M44 8 v28" stroke="#8b5e3c" stroke-width="3" stroke-linecap="round"/>
    <path d="M52 12 h-6 a2 2 0 0 0 -2 2 v2 a4 4 0 0 0 4 4 h2 a4 4 0 0 0 4 -4 v-2 a2 2 0 0 0 -2 -2 z" fill="#ffd54f" stroke="#caa031" stroke-width="1"/>
    <path d="M48 22 v3 m-3 3 h6" stroke="#caa031" stroke-width="1.5" stroke-linecap="round"/>
    <g transform="translate(8,16)">
      <ellipse cx="16" cy="24" rx="12" ry="10" fill="#ffd54f" stroke="#f4b400" stroke-width="2"/>
      <ellipse cx="18" cy="12" rx="10" ry="9" fill="#ffd54f" stroke="#f4b400" stroke-width="2"/>
      <path d="M12 3 l-2 -6 a3 3 0 0 1 5 0 l0 7 z" fill="#ffd54f" stroke="#f4b400" stroke-width="2"/>
      <path d="M24 3 l2 -6 a3 3 0 0 0 -5 0 l0 7 z" fill="#ffd54f" stroke="#f4b400" stroke-width="2"/>
      <path d="M10 -4 l4 6" stroke="#333" stroke-width="3" stroke-linecap="round"/>
      <path d="M26 -4 l-4 6" stroke="#333" stroke-width="3" stroke-linecap="round"/>
      <circle cx="14" cy="11" r="1.4" fill="#222"/>
      <circle cx="22" cy="11" r="1.4" fill="#222"/>
      <circle cx="12" cy="15" r="2" fill="#ff5252" opacity="0.85"/>
      <circle cx="24" cy="15" r="2" fill="#ff5252" opacity="0.85"/>
      <path d="M14 17 q4 3 8 0" stroke="#333" stroke-width="1.6" fill="none" stroke-linecap="round"/>
      <path d="M22 20 q8 -4 20 -10" stroke="#f4b400" stroke-width="4" stroke-linecap="round"/>
      <path d="M6 22 l-6 2 6 2 -4 8 12 -6" fill="#ffd54f" stroke="#f4b400" stroke-width="2" stroke-linejoin="round"/>
    </g>
  </svg>`;
}

async function refreshAuthUI(){
  const u = getCurrentUser();
  document.getElementById('whoami').innerHTML = u ? `Sveiks, <b>${u.username}</b>` : '‚Äî';
  const bal = u ? await getUserBalance(u.id) : null;
  document.getElementById('balance').textContent = bal!=null ? bal : '‚Äî';
}

async function doRegister(){
  const username = document.getElementById('authUser').value.trim();
  const password = document.getElementById('authPass').value;
  if(!username || !password) return alert('Ievadiet lietotƒÅjvƒÅrdu un paroli');
  const ok = await registerUser(username, password);
  if(ok){ alert('Reƒ£istrƒÅcija veiksmƒ´ga!'); await doLogin(); }
}

async function doLogin(){
  const username = document.getElementById('authUser').value.trim();
  const password = document.getElementById('authPass').value;
  const u = await loginUser(username, password);
  if(u){ await refreshAuthUI(); await renderBets(); await renderMyBets(); }
}

function doLogout(){
  logoutUser();
  refreshAuthUI();
  renderBets();
  renderMyBets();
}

function computeOdds(m){
  const A=(m.betsA||0), B=(m.betsB||0), T=A+B, eps=1e-6, factor=.925;
  if(T<=eps) return [1.00,1.00];
  const oa=factor*(T/Math.max(A,eps)), ob=factor*(T/Math.max(B,eps));
  return [Number(oa.toFixed(2)), Number(ob.toFixed(2))];
}

async function renderBets(){
  const matches = await loadMatchesDB();
  const u = getCurrentUser();

  const html = matches.map(m=>{
    const [oa,ob]=computeOdds(m);
    const winA = m.winner==='A', winB = m.winner==='B';
    return `<div class="bet-card">
      <div class="bet-grid">
        <div class="bet-team ${winA?'win-glow':''}">
          ${winA? pikachuSVG(): ''}
          <div><b>${m.A}</b></div>
          <div class="muted">koef: <b>${oa}</b></div>
          ${winA? '<div class="win-label">üèÜ UzvarƒìtƒÅjs!</div>':''}
        </div>
        <div class="bet-vs">vs</div>
        <div class="bet-team ${winB?'win-glow':''}">
          ${winB? pikachuSVG(): ''}
          <div><b>${m.B}</b></div>
          <div class="muted">koef: <b>${ob}</b></div>
          ${winB? '<div class="win-label">üèÜ UzvarƒìtƒÅjs!</div>':''}
        </div>
      </div>
      <div class="center" style="margin-top:6px">
        ${m.open
          ? (u? `<button onclick="doBet(${m.id},'A')">Likts uz ${m.A}</button> <button onclick="doBet(${m.id},'B')">Likts uz ${m.B}</button>` : '<span class="muted">Ieiet, lai liktu likmes</span>')
          : '<span class="match-closed">Maƒçs noslƒìgts</span>'
        }
      </div>
      ${ (u && u.username==='dturannn') ? `<div class="center" style="margin-top:6px">
        <button onclick="adminWin(${m.id},'A')">Uzvara ${m.A}</button>
        <button onclick="adminWin(${m.id},'B')">Uzvara ${m.B}</button>
      </div>`:''}
    </div>`;
  }).join('') || '<p class="muted">Nav maƒçu.</p>';

  document.getElementById('betCards').innerHTML = html;
}

async function doBet(id, side){
  const u = getCurrentUser(); if(!u) return alert('Ieiet kontƒÅ');
  const bal = await getUserBalance(u.id);
  const amt = parseFloat(prompt(`Summa (kr), bilance ${bal} kr:`,'1')||'0');
  if(!(amt>0)) return;
  if(bal < amt) return alert('Nepietiek bilance.');
  await placeBetDB(u.id, id, side, amt);
  await refreshAuthUI();
  await renderBets();
  await renderMyBets();
}

async function adminWin(id, side){
  const u=getCurrentUser(); if(!u || u.username!=='dturannn') return alert('Nav tiesƒ´bu');
  await setWinnerDB(id, side);
  await renderBets();
}

async function createMatch(){
  const u=getCurrentUser(); if(!u || u.username!=='dturannn') return alert('Nav tiesƒ´bu');
  const A=document.getElementById('teamA').value.trim();
  const B=document.getElementById('teamB').value.trim();
  if(!A||!B||A===B) return alert('Nepareizi lauki');
  await createMatchDB({A,B,deadline:0});
  document.getElementById('teamA').value='';
  document.getElementById('teamB').value='';
  await renderBets();
}

async function renderMyBets(){
  const u=getCurrentUser();
  if(!u){ document.getElementById('myBets').innerHTML='<p class="muted">Ieiet, lai redzƒìtu likmes.</p>'; return; }
  const bets = await getUserBets(u.id);
  const rows = bets.slice().reverse().map(b=>{
    const res = b.winner ? (b.winner===b.side ? '‚úîÔ∏è' : '‚ùå') : '‚Äî';
    return `<tr><td>#${b.match_id}</td><td>${b.A} vs ${b.B}</td><td>${b.side}</td><td>${b.amount}</td><td>${res}</td></tr>`;
  }).join('');
  document.getElementById('myBets').innerHTML = rows ? `<table class="table"><thead><tr><th>ID</th><th>Maƒçs</th><th>Side</th><th>Summa</th><th>Rez</th></tr></thead><tbody>${rows}</tbody></table>` : '<p class="muted">Nav likmju.</p>';
}

window.doRegister = doRegister;
window.doLogin = doLogin;
window.doLogout = doLogout;
window.createMatch = createMatch;
window.adminWin = adminWin;
window.doBet = doBet;
window.renderBets = renderBets;

await refreshAuthUI();
await renderBets();
await renderMyBets();
</script>
</body>
</html>
