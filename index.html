<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fantasy League — Firebase Demo</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:0;background:#0e1014;color:#e6e6e6}
    header{padding:14px 16px;background:#141824;display:flex;gap:16px;align-items:center;justify-content:space-between;border-bottom:1px solid #222}
    .wrap{max-width:980px;margin:20px auto;padding:0 16px}
    .card{background:#171b29;border:1px solid #2a2f45;border-radius:12px;padding:16px;margin-bottom:14px;position:relative}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input,select,button{background:#0f1320;border:1px solid #2a2f45;color:#e6e6e6;border-radius:8px;padding:10px 12px}
    input,select{min-width:200px}
    button{cursor:pointer}
    .muted{opacity:.7}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#222;font-size:12px;margin-left:6px}
    .right{margin-left:auto}
    .danger{background:#3a1014;border-color:#712530}
    .ok{background:#103a18;border-color:#2e6b3a}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .center{display:flex;align-items:center;gap:8px}
    .logo{width:24px;height:24px;border-radius:6px;object-fit:cover;background:#222}
    .winner-glow{animation:neonPulse 1.8s ease-in-out infinite;border-radius:10px;border:2px solid rgba(255,255,255,.4)}
    @keyframes neonPulse{
      0%{box-shadow:0 0 6px #2cff72,0 0 12px #2cff72}
      33%{box-shadow:0 0 6px #ff9a2c,0 0 12px #ff9a2c}
      66%{box-shadow:0 0 6px #2cb7ff,0 0 12px #2cb7ff}
      100%{box-shadow:0 0 6px #2cff72,0 0 12px #2cff72}
    }
    .pikachu{display:none;position:absolute;right:-6px;top:-18px;width:42px;height:42px;
      background:url('https://i.imgur.com/H7VtZQG.png') no-repeat center/contain}
    .winner .pikachu{display:block}
    .tabs{display:flex;gap:8px;margin-bottom:10px}
    .tabs button{background:#141824}
    .tabs button.active{background:#1f2538}
    small{opacity:.65}
  </style>
</head>
<body>
<header>
  <div class="row">
    <strong>Fantasy League</strong>
    <span id="adminBalance" class="pill">admin: 0</span>
  </div>
  <div class="row" id="authBox">
    <input id="uName" placeholder="логин" />
    <input id="uPass" placeholder="пароль" type="password" />
    <button id="btnReg">Регистрация</button>
    <button id="btnLogin">Войти</button>
  </div>
  <div class="row" id="userBox" style="display:none">
    <span id="userLabel"></span>
    <span id="userBalance" class="pill">баланс: 0</span>
    <button id="btnLogout">Выйти</button>
  </div>
</header>

<div class="wrap">
  <div class="tabs">
    <button class="active" data-tab="bets">Матчи</button>
    <button data-tab="profile">Профиль</button>
    <button data-tab="admin">Админ</button>
  </div>

  <section id="tab-bets">
    <div id="matches"></div>
  </section>

  <section id="tab-profile" style="display:none">
    <div class="card">
      <h3>Мой профиль</h3>
      <div id="myInfo" class="muted">войдите, чтобы увидеть данные</div>
    </div>
  </section>

  <section id="tab-admin" style="display:none">
    <div class="card">
      <h3>Админка <small>(логин должен быть <b>dturannn</b>)</small></h3>
      <div class="grid">
        <div class="card">
          <h4>Добавить команду</h4>
          <div class="row">
            <input id="teamName" placeholder="Название команды" />
            <input id="teamLogoUrl" placeholder="URL логотипа (https://...)" />
            <button id="btnAddTeam">+ Команда</button>
          </div>
          <div id="teamsList" class="muted" style="margin-top:8px"></div>
        </div>
        <div class="card">
          <h4>Создать матч</h4>
          <div class="row">
            <select id="matchA"></select>
            <select id="matchB"></select>
            <button id="btnCreateMatch">Создать</button>
          </div>
        </div>
      </div>
      <div class="card">
        <h4>Текущие матчи</h4>
        <div id="adminMatches"></div>
      </div>
    </div>
  </section>
</div>

<!-- подключение логики -->
<script type="module">
import {
  getCurrentUser, registerUser, loginUser, logoutUser,
  loadTeams, addTeam,
  loadMatchesDB, createMatchDB, setWinnerDB, placeBetDB,
  getUserBalance, subscribeRealtime, getAdminBalance
} from './firebase.js';

/* ===== helpers ===== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
function objToArray(o){ return o ? Object.keys(o).map(id=>({id,...o[id]})) : []; }

/* ===== auth widgets ===== */
function refreshAuthUI(){
  const u = getCurrentUser();
  if(u){
    $('#authBox').style.display='none';
    $('#userBox').style.display='flex';
    $('#userLabel').textContent = u.username;
  }else{
    $('#authBox').style.display='flex';
    $('#userBox').style.display='none';
  }
}
async function refreshBalances(){
  const u = getCurrentUser();
  if(u){
    const bal = await getUserBalance(u.id);
    $('#userBalance').textContent = 'баланс: ' + Math.round(bal);
  }
  const ab = await getAdminBalance();
  $('#adminBalance').textContent = 'admin: ' + Math.round(ab);
}

/* ===== tabs ===== */
$$('.tabs button').forEach(b=>{
  b.onclick = ()=>{
    $$('.tabs button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const tab = b.dataset.tab;
    $('#tab-bets').style.display = tab==='bets'?'block':'none';
    $('#tab-profile').style.display = tab==='profile'?'block':'none';
    $('#tab-admin').style.display = tab==='admin'?'block':'none';
  };
});

/* ===== auth handlers ===== */
$('#btnReg').onclick = async ()=>{
  const u = $('#uName').value.trim(); const p = $('#uPass').value.trim();
  if(!u || !p) return alert('Заполни логин/пароль');
  const ok = await registerUser(u,p);
  if(ok){ refreshAuthUI(); refreshBalances(); }
};
$('#btnLogin').onclick = async ()=>{
  const u = $('#uName').value.trim(); const p = $('#uPass').value.trim();
  const me = await loginUser(u,p);
  if(me){ refreshAuthUI(); refreshBalances(); renderAll(); }
};
$('#btnLogout').onclick = ()=>{ logoutUser(); refreshAuthUI(); renderAll(); };

/* ===== admin UI ===== */
async function loadTeamsIntoSelects(){
  const teams = await loadTeams();
  const opts = (t)=> `<option value="${t.name}" data-logo="${t.logo_url||''}">${t.name}</option>`;
  $('#matchA').innerHTML = '<option value="">— Команда A —</option>' + teams.map(opts).join('');
  $('#matchB').innerHTML = '<option value="">— Команда B —</option>' + teams.map(opts).join('');
  $('#teamsList').innerHTML = teams.map(t=>`<div class="center"><img class="logo" src="${t.logo_url||''}"> ${t.name}</div>`).join('') || '<small>нет команд</small>';
}
$('#btnAddTeam').onclick = async ()=>{
  const n = $('#teamName').value.trim();
  const url = $('#teamLogoUrl').value.trim();
  if(!n) return alert('Название?');
  await addTeam(n, url || null);
  $('#teamName').value=''; $('#teamLogoUrl').value='';
  loadTeamsIntoSelects();
};
$('#btnCreateMatch').onclick = async ()=>{
  const A = $('#matchA').value; const B = $('#matchB').value;
  if(!A || !B || A===B) return alert('Выбери разные команды');
  await createMatchDB({A,B,deadline:0});
  renderAll();
};

/* ===== render matches (public) ===== */
function matchCard(m){
  const total = (m.betsA||0)+(m.betsB||0);
  const pA = total>0? Math.round(m.betsA/total*100) : 0;
  const pB = total>0? 100-pA : 0;
  const winnerClassA = (!m.open && m.winner==='A') ? 'winner-glow winner':'';
  const winnerClassB = (!m.open && m.winner==='B') ? 'winner-glow winner':'';

  return `
  <div class="card" data-match-id="${m.id}" data-winner="${m.winner||''}" data-percent-a="${pA}" data-percent-b="${pB}">
    <div class="pikachu"></div>
    <div class="grid">
      <div class="${winnerClassA}">
        <div class="center"><span class="name">A: ${m.A}</span> <span class="pill">${pA}%</span></div>
        ${m.open ? `<button data-bet="A" data-id="${m.id}">Ставка на A</button>` : `<small class="muted">Матч закрыт</small>`}
      </div>
      <div class="${winnerClassB}">
        <div class="center"><span class="name">B: ${m.B}</span> <span class="pill">${pB}%</span></div>
        ${m.open ? `<button data-bet="B" data-id="${m.id}">Ставка на B</button>` : `<small class="muted">Матч закрыт</small>`}
      </div>
    </div>
    <div style="margin-top:8px" class="muted">Сумма ставок: A=${Math.round(m.betsA||0)} | B=${Math.round(m.betsB||0)}</div>
  </div>`;
}

async function renderBets(){
  const ms = await loadMatchesDB();           // <- гарантированно массив
  $('#matches').innerHTML = ms.map(matchCard).join('') || '<div class="card muted">Пока нет матчей</div>';
  // кнопки ставок
  $('#matches').querySelectorAll('button[data-bet]').forEach(btn=>{
    btn.onclick = async ()=>{
      const side = btn.getAttribute('data-bet');
      const id = btn.getAttribute('data-id');
      const me = getCurrentUser();
      if(!me) return alert('Сначала войдите');
      const bal = await getUserBalance(me.id);
      const amt = parseFloat(prompt(`Сумма (баланс ${Math.round(bal)})`, '10')||'0');
      if(!(amt>0)) return;
      if(bal < amt) return alert('Недостаточно средств');
      await placeBetDB(me.id, id, side, amt);
      refreshBalances();
    };
  });
}

/* ===== render admin matches ===== */
async function renderAdmin(){
  const me = getCurrentUser();
  const isAdmin = me && me.username === 'dturannn';
  $('#tab-admin').style.display = isAdmin ? 'block' : 'none';
  if(!isAdmin) return;

  await loadTeamsIntoSelects();
  const ms = await loadMatchesDB();
  $('#adminMatches').innerHTML = ms.map(m=>`
    <div class="card">
      <div class="row">
        <div>A: <b>${m.A}</b> <span class="pill">${Math.round((m.betsA||0)/( (m.betsA||0)+(m.betsB||0) || 1)*100)}%</span></div>
        <div>B: <b>${m.B}</b> <span class="pill">${Math.round((m.betsB||0)/( (m.betsA||0)+(m.betsB||0) || 1)*100)}%</span></div>
        <span class="right muted">${m.open ? 'открыт' : ('закрыт, победа: '+m.winner)}</span>
      </div>
      ${m.open ? `
        <div class="row" style="margin-top:8px">
          <button class="ok" data-win="A" data-id="${m.id}">Победа A</button>
          <button class="ok" data-win="B" data-id="${m.id}">Победа B</button>
        </div>` : ''}
    </div>
  `).join('') || '<div class="muted">нет матчей</div>';

  $('#adminMatches').querySelectorAll('button[data-win]').forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.getAttribute('data-id');
      const side = btn.getAttribute('data-win');
      if(!confirm(`Закрыть матч и выбрать победу ${side}?`)) return;
      await setWinnerDB(id, side);  // внутри будут выплаты и 7.5% админу
      refreshBalances();
    };
  });
}

/* ===== profile ===== */
async function renderProfile(){
  const u = getCurrentUser();
  if(!u) { $('#myInfo').textContent='войдите, чтобы увидеть данные'; return; }
  const bal = await getUserBalance(u.id);
  $('#myInfo').innerHTML = `<b>${u.username}</b><br/>Баланс: ${Math.round(bal)}`;
}

/* ===== full repaint ===== */
async function renderAll(){
  refreshAuthUI();
  await renderBets();
  await renderAdmin();
  await renderProfile();
  await refreshBalances();
}

/* realtime updates */
subscribeRealtime(()=> { renderAll(); });

/* first render */
renderAll();
</script>
</body>
</html>
