
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fantasy League v6 ‚Äî Green AutoClean</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
<header>
  <div class="container row">
    <div class="h1">Fantasy League <span class="pill">v6</span></div>
    <div class="right row" id="authBox">
      <input id="uName" placeholder="–ª–æ–≥–∏–Ω" />
      <input id="uPass" placeholder="–ø–∞—Ä–æ–ª—å" type="password" />
      <button id="btnReg" class="ghost">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      <button id="btnLogin" class="primary">–í–æ–π—Ç–∏</button>
    </div>
    <div class="right row hide" id="userBox">
      <span id="userLabel" class="pill"></span>
      <span id="userBalanceBets" class="pill">—Å—Ç–∞–≤–∫–∏: 0</span>
      <span id="userBalanceFantasy" class="pill">fantasy: 0</span>
      <button id="btnLogout" class="ghost">–í—ã–π—Ç–∏</button>
    </div>
  </div>
</header>

<div class="container content">
  <section id="tab-home">
    <div class="card">
      <h3>–ú–∞—Ç—á–∏</h3>
      <div id="matches"></div>
    </div>
    <div class="card hide" id="adminPanel">
      <h3>–ê–¥–º–∏–Ω–∫–∞</h3>
      <div class="row"><b>–°–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É</b></div>
      <div class="row">
        <input id="teamName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" />
        <input id="teamLogo" placeholder="URL –ª–æ–≥–æ—Ç–∏–ø–∞" />
        <input id="teamTag" placeholder="–¢–µ–≥ (3-5)" style="width:120px" />
        <input id="teamCountry" placeholder="–°—Ç—Ä–∞–Ω–∞" style="width:140px" />
        <button id="btnAddTeam" class="ghost">+ –ö–æ–º–∞–Ω–¥–∞</button>
      </div>
      <div class="hr"></div>
      <div class="row"><b>–°–æ–∑–¥–∞—Ç—å –º–∞—Ç—á</b></div>
      <div class="row">
        <select id="selA"></select>
        <select id="selB"></select>
        <button id="btnCreateMatch" class="primary">+ –ú–∞—Ç—á</button>
        <div class="right pill" id="adminBalance">admin: 0</div>
      </div>
      <div class="hr"></div>
      <div id="adminMatches"></div>
    </div>
  </section>

  <section id="tab-fantasy" class="hide">
    <div class="card">
      <div class="row">
        <h3>–§—ç–Ω—Ç–µ–∑–∏ –õ–∏–≥–∞</h3>
        <div class="right row">
          <span class="pill">üí∞ FP: <b id="fpVal">0</b></span>
          <button class="ghost" id="btnFantasyMy">–ú–æ—è –∫–æ–º–∞–Ω–¥–∞</button>
          <button class="primary" id="btnFantasyLeaders">–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</button>
        </div>
      </div>
    </div>

    <div id="fantasy-my" class="card">
      <h4>–°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ (–º–æ–∂–Ω–æ –∫—É–ø–∏—Ç—å)</h4>
      <div id="playersList"></div>
    </div>

    <div id="fantasy-leaders" class="card hide">
      <h4>–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h4>
      <div id="leadersTable"></div>
    </div>

    <div class="card hide" id="fantasyAdmin">
      <h4>–ê–¥–º–∏–Ω: –æ—á–∫–∏ –∏ —Å—Ç–∞—Ç—ã –∏–≥—Ä–æ–∫–∞</h4>
      <div class="row">
        <select id="scorePlayer"></select>
        <input id="scoreDelta" type="number" placeholder="Œî –æ—á–∫–æ–≤" />
        <button id="btnScoreApply" class="ghost">+/- –û—á–∫–∏</button>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="statKD" placeholder="KD" style="width:90px" />
        <input id="statADR" placeholder="ADR" style="width:90px" />
        <input id="statHS" placeholder="HS%" style="width:90px" />
        <input id="statHLTV" placeholder="HLTV" style="width:90px" />
        <input id="statImpact" placeholder="Impact" style="width:110px" />
        <input id="statTeamRating" placeholder="TeamRating" style="width:130px" />
        <button id="btnSaveStats" class="ghost">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç—ã</button>
      </div>
    </div>
  </section>

  <section id="tab-profile" class="hide">
    <div class="card">
      <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
      <div id="profileBox" class="muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–∞–Ω–Ω—ã–µ</div>
    </div>
  </section>
</div>

<nav class="navbar">
  <div class="inner">
    <a class="tabbtn active" data-tab="home"><span class="icon">üè†</span><span>–ú–∞—Ç—á–∏</span></a>
    <a class="tabbtn" data-tab="fantasy"><span class="icon">üèÜ</span><span>Fantasy</span></a>
    <a class="tabbtn" data-tab="profile"><span class="icon">üë§</span><span>–ü—Ä–æ—Ñ–∏–ª—å</span></a>
  </div>
</nav>

<div class="modal" id="playerModal">
  <div class="sheet">
    <button class="close" id="modalClose">‚úï</button>
    <div id="modalBody"></div>
  </div>
</div>

<script type="module">
import {
  getCurrentUser, registerUser, loginUser, logoutUser,
  getUserBalances, setInitialFantasyIfNeeded,
  loadTeams, addTeam, loadMatchesDB, createMatchFromTeams, setWinnerDB, placeBetDB,
  getAdminBalance, subscribeRealtime,
  loadFantasyPlayers, buyFantasyPlayer, loadFantasyTeams, addPlayerPoints, savePlayerStats,
  initializeIfFirstAdmin
} from './firebase.js';

const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
const fmt = n=> Math.round(Number(n||0));
function toast(msg, ok=true){ const t=document.createElement('div'); t.className='toast'; t.style.borderColor = ok?'#19d26b':'#ff4d4f'; t.style.boxShadow = ok?'0 0 8px #19d26b':'0 0 8px #ff4d4f'; t.textContent = msg; document.body.appendChild(t); setTimeout(()=>t.remove(), 2000); }
function showTab(name){ $('#tab-home').classList.toggle('hide', name!=='home'); $('#tab-fantasy').classList.toggle('hide', name!=='fantasy'); $('#tab-profile').classList.toggle('hide', name!=='profile'); $$('.tabbtn').forEach(b=> b.classList.toggle('active', b.dataset.tab===name)); }
$$('.tabbtn').forEach(b=> b.addEventListener('click', ()=> showTab(b.dataset.tab)));

function refreshAuthUI(){ const u=getCurrentUser(); $('#authBox').classList.toggle('hide', !!u); $('#userBox').classList.toggle('hide', !u); const isAdmin = u && u.username==='dturannn'; $('#adminPanel').classList.toggle('hide', !isAdmin); $('#fantasyAdmin').classList.toggle('hide', !isAdmin); if(u){ $('#userLabel').textContent = u.username; } }
async function refreshBalances(){ const u=getCurrentUser(); if(!u) return; const b = await getUserBalances(u.id); $('#userBalanceBets').textContent = '—Å—Ç–∞–≤–∫–∏: '+fmt(b.balanceBets); $('#userBalanceFantasy').textContent = 'fantasy: '+fmt(b.balanceFantasy); $('#fpVal').textContent = fmt(b.balanceFantasy); const ab = await getAdminBalance(); $('#adminBalance').textContent = 'admin: '+fmt(ab); }
$('#btnReg').onclick = async ()=>{ const u=$('#uName').value.trim(), p=$('#uPass').value.trim(); if(!u||!p) return alert('–ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å?'); const ok = await registerUser(u,p); if(ok){ refreshAuthUI(); await setInitialFantasyIfNeeded(); await refreshBalances(); renderAll(); } };
$('#btnLogin').onclick = async ()=>{ const u=$('#uName').value.trim(), p=$('#uPass').value.trim(); const me = await loginUser(u,p);
  if(me){ refreshAuthUI(); await setInitialFantasyIfNeeded(); await refreshBalances(); 
    if(me.username==='dturannn'){ await initializeIfFirstAdmin(); toast('–ë–∞–∑–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞'); }
    renderAll(); 
  } 
};
$('#btnLogout').onclick = ()=>{ logoutUser(); refreshAuthUI(); renderAll(); };

function matchCard(m){ const total=(m.betsA||0)+(m.betsB||0); const pA= total>0? Math.round((m.betsA||0)/total*100):0; const pB= total>0? 100-pA:0; const glowA = (!m.open && m.winner==='A') ? 'winner-glow winner' : ''; const glowB = (!m.open && m.winner==='B') ? 'winner-glow winner' : ''; return `<div class="card" data-match-id="${m.id}" data-winner="${m.winner||''}"><div class="pikachu"></div><div class="grid2"><div class="${glowA}"><div class="flex"><img class="logo" src="${m.logoA||''}"/><span class="name">${m.A}</span><span class="pill">${pA}%</span></div>${m.open?`<button data-bet="A" data-id="${m.id}" class="ghost">–°—Ç–∞–≤–∫–∞ –Ω–∞ A</button>`:`<small class="muted">–ú–∞—Ç—á –∑–∞–∫—Ä—ã—Ç</small>`}</div><div class="${glowB}"><div class="flex"><img class="logo" src="${m.logoB||''}"/><span class="name">${m.B}</span><span class="pill">${pB}%</span></div>${m.open?`<button data-bet="B" data-id="${m.id}" class="ghost">–°—Ç–∞–≤–∫–∞ –Ω–∞ B</button>`:`<small class="muted">–ú–∞—Ç—á –∑–∞–∫—Ä—ã—Ç</small>`}</div></div><div class="hr"></div><small class="muted">–°—Ç–∞–≤–∫–∏: A=${fmt(m.betsA)} | B=${fmt(m.betsB)}</small></div>`; }
async function renderMatches(){ const ms = await loadMatchesDB(); $('#matches').innerHTML = ms.map(matchCard).join('') || '<div class="card muted">–ù–µ—Ç –º–∞—Ç—á–µ–π</div>'; $('#matches').querySelectorAll('button[data-bet]').forEach(btn=>{ btn.onclick = async ()=>{ const me=getCurrentUser(); if(!me) return alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ'); const side=btn.dataset.bet, id=btn.dataset.id; const b = await getUserBalances(me.id); const bal=b.balanceBets||0; const amt=parseFloat(prompt(`–°—É–º–º–∞ (–±–∞–ª–∞–Ω—Å ${fmt(bal)})`,'10')||'0'); if(!(amt>0)) return; if(bal<amt) return alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'); await placeBetDB(me.id, id, side, amt); await refreshBalances(); }; }); }
async function hydrateTeamSelects(){ const teams = await loadTeams(); const opt = t=>`<option value="${t.id}" data-logo="${t.logo_url||''}" data-name="${t.name}">${t.name}</option>`; $('#selA').innerHTML = '<option value="">‚Äî –ö–æ–º–∞–Ω–¥–∞ A ‚Äî</option>'+teams.map(opt).join(''); $('#selB').innerHTML = '<option value="">‚Äî –ö–æ–º–∞–Ω–¥–∞ B ‚Äî</option>'+teams.map(opt).join(''); }
$('#btnAddTeam').onclick = async ()=>{ const name=$('#teamName').value.trim(), logo=$('#teamLogo').value.trim(), tag=$('#teamTag').value.trim(), country=$('#teamCountry').value.trim(); if(!name) return alert('–ù–∞–∑–≤–∞–Ω–∏–µ?'); await addTeam(name, logo, tag, country); $('#teamName').value=$('#teamLogo').value=$('#teamTag').value=$('#teamCountry').value=''; hydrateTeamSelects(); toast('–ö–æ–º–∞–Ω–¥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞'); };
$('#btnCreateMatch').onclick = async ()=>{ const a=$('#selA').value, b=$('#selB').value; if(!a||!b||a===b) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã'); await createMatchFromTeams(a,b); toast('–ú–∞—Ç—á —Å–æ–∑–¥–∞–Ω'); };

let players=[];
function playerRow(p){ return `<div class="player-row"><div class="flex"><img class="logo" src="${p.team_logo||''}" onerror="this.style.opacity=.2"/><div><div><b>${p.name}</b> <span class="badge">Tier ${p.tier}</span> <span class="badge">–¶–µ–Ω–∞: ${p.price_points} FP</span></div><small class="muted">${p.team||'-'}</small></div></div><div class="flex"><button class="ghost" data-view="${p.id}">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button><button class="primary" data-buy="${p.id}">–ö—É–ø–∏—Ç—å</button></div></div>`; }
function renderPlayers(){ $('#playersList').innerHTML = players.map(playerRow).join(''); $('#playersList').querySelectorAll('button[data-buy]').forEach(b=> b.onclick = ()=> buyPlayer(b.dataset.buy)); $('#playersList').querySelectorAll('button[data-view]').forEach(b=> b.onclick = ()=> openPlayer(b.dataset.view)); }
async function buyPlayer(id){ const u=getCurrentUser(); if(!u) return alert('–í–æ–π–¥–∏—Ç–µ'); const ok = await buyFantasyPlayer(u.id, id); if(ok.ok){ toast('–ò–≥—Ä–æ–∫ –∫—É–ø–ª–µ–Ω!'); refreshBalances(); } else { toast(ok.msg||'–ù–µ —É–¥–∞–ª–æ—Å—å', false); } }
function openPlayer(id){ const p = players.find(x=>x.id===id); if(!p) return; $('#playerModal').classList.add('open'); $('#modalBody').innerHTML = `<div class="flex"><img class="logo" src="${p.team_logo||''}"/><div><b>${p.name}</b><div class="muted">${p.team||''}</div></div><div class="right"><span class="pill">Tier ${p.tier}</span> <span class="pill">${p.price_points} FP</span></div></div><div class="hr"></div><div class="grid3"><div><small class="muted">KD</small><div>${p.kd||'-'}</div></div><div><small class="muted">ADR</small><div>${p.adr||'-'}</div></div><div><small class="muted">HS%</small><div>${p.hs||'-'}</div></div><div><small class="muted">HLTV</small><div>${p.hltv||'-'}</div></div><div><small class="muted">Impact</small><div>${p.impact||'-'}</div></div><div><small class="muted">Team Rating</small><div>${p.team_rating||'-'}</div></div></div><div class="hr"></div><button class="primary" id="modalBuy">–ö—É–ø–∏—Ç—å –∏–≥—Ä–æ–∫–∞</button>`; $('#modalBuy').onclick = ()=> buyPlayer(id); }
$('#modalClose').onclick = ()=> $('#playerModal').classList.remove('open');
$('#playerModal').addEventListener('click', (e)=>{ if(e.target.id==='playerModal') $('#playerModal').classList.remove('open'); });

function renderLeadersTable(teams){ const rows = teams.sort((a,b)=> (b.total_points||0)-(a.total_points||0)).map((t,i)=>`<tr><td>${i+1}</td><td>${t.manager}</td><td>${fmt(t.total_points)}</td></tr>`).join(''); $('#leadersTable').innerHTML = `<table><thead><tr><th>#</th><th>–ú–µ–Ω–µ–¥–∂–µ—Ä</th><th>–û—á–∫–∏</th></tr></thead><tbody>${rows || '<tr><td colspan="3"><small class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</small></td></tr>'}</tbody></table>`; }
$('#btnFantasyMy').onclick = ()=>{ $('#fantasy-my').classList.remove('hide'); $('#fantasy-leaders').classList.add('hide'); };
$('#btnFantasyLeaders').onclick = ()=>{ $('#fantasy-my').classList.add('hide'); $('#fantasy-leaders').classList.remove('hide'); };

async function renderProfile(){ const u=getCurrentUser(); if(!u){ $('#profileBox').textContent='–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–∞–Ω–Ω—ã–µ'; return; } const b=await getUserBalances(u.id); $('#profileBox').innerHTML = `<b>${u.username}</b><br/>–°—Ç–∞–≤–∫–∏: ${fmt(b.balanceBets)} | Fantasy: ${fmt(b.balanceFantasy)}`; }

async function renderAll(){ refreshAuthUI(); await hydrateTeamSelects(); await renderMatches(); players = await loadFantasyPlayers(); renderPlayers(); renderLeadersTable(await loadFantasyTeams()); await renderProfile(); const u=getCurrentUser(); if(u){ await refreshBalances(); } }
subscribeRealtime(()=> renderAll());
renderAll();
</script>
  <!-- Fantasy -->
<div id="tab-fantasy" class="tab hide">
  <h2>–ú–æ—è –∫–æ–º–∞–Ω–¥–∞</h2>
  <div id="myTeamBox" class="players-grid"></div>
  <h2>–í—Å–µ –∏–≥—Ä–æ–∫–∏</h2>
  <div id="allPlayersBox" class="players-grid"></div>
</div>

<!-- Admin -->
<div id="tab-admin" class="tab hide">
  <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É</h3>
  <select id="teamSelect"></select>
  <input id="teamLogoUrl" placeholder="URL –ª–æ–≥–æ—Ç–∏–ø–∞">
  <button id="saveTeamLogo">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>

  <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä–æ–∫–∞</h3>
  <select id="playerSelect"></select>
  <input id="playerPoints" type="number" placeholder="–û—á–∫–∏">
  <input id="playerAchievements" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π">
  <button id="savePlayerStats">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

</body>
</html>
