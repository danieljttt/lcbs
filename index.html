<!doctype html>
<html lang="lv">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>LCBS Fantasy</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<header class="row">
  <button class="tabbtn active" data-tab="home">SÄkums</button>
  <button class="tabbtn" data-tab="fantasy">Fantasy</button>
  <button class="tabbtn" data-tab="bets">Likmes</button>
  <button class="tabbtn" data-tab="profile">Profils</button>
  <div style="flex:1"></div>
  <span id="userLabel" class="badge">viesis</span>
</header>

<div id="tab-home" class="container">
  <h2>LCBS Fantasy</h2>
  <p class="note">VienkÄrÅ¡a lapa uz GitHub Pages + Firebase Realtime Database.</p>
  <div class="section card">
    <div class="row">
      <input id="uName" placeholder="lietotÄjvÄrds">
      <input id="uPass" placeholder="parole" type="password">
      <button id="btnReg">ReÄ£istrÄ“ties</button>
      <button id="btnLogin">Pieteikties</button>
      <button id="btnLogout" class="hide">IzrakstÄ«ties</button>
    </div>
    <div class="row small" style="margin-top:8px">
      <span>Likmju bilance: <b id="userBalanceBets">0</b></span>
      <span> â€¢ </span>
      <span>Fantasy kredÄ«ti: <b id="userBalanceFantasy">0</b></span>
    </div>
  </div>

  <div id="adminPanel" class="card hide">
    <h2>AdministrÄ“Å¡ana</h2>
    <div class="section">
      <h3>Komandas â€” logo</h3>
      <div class="row">
        <select id="teamSelect"></select>
        <input id="teamLogoUrl" placeholder="Komandas logo URL">
        <button id="saveTeamLogo">SaglabÄt</button>
      </div>
    </div>

    <div class="section">
      <h3>SpÄ“lÄ“tÄji â€” statistika</h3>
      <div class="row">
        <select id="playerSelect"></select>
        <input id="playerPoints" type="number" placeholder="Punkti">
        <input id="playerAchievements" placeholder="Sasniegumi (teksts)">
        <button id="savePlayerStats">SaglabÄt</button>
      </div>
    </div>

    <div class="section">
      <h3>LietotÄji â€” bilances</h3>
      <button id="refreshUsersList">Atjaunot sarakstu</button>
      <div id="usersList"></div>
    </div>

    <div class="section">
      <h3>SpÄ“les (Likmes) â€” administrÄ“Å¡ana</h3>
      <div class="row">
        <input id="mTeam1" placeholder="Komanda 1">
        <input id="mTeam2" placeholder="Komanda 2">
        <input id="mTournament" placeholder="TurnÄ«rs">
        <input id="mTime" placeholder="Laiks (YYYY-MM-DD HH:MM)">
        <button id="mAdd">Pievienot spÄ“li</button>
      </div>
      <p class="note">Lai noslÄ“gtu spÄ“li, noklikÅ¡Ä·ini uz tÄs kartes â€œUzvarÄ“tÄjsâ€ un â€œAizvÄ“rt spÄ“liâ€.</p>
    </div>
  </div>
</div>

<div id="tab-fantasy" class="container hide">
  <h2>Mana komanda (maks. 3 spÄ“lÄ“tÄji)</h2>
  <div id="myTeamBox"></div>
  <h2>Visi spÄ“lÄ“tÄji</h2>
  <div id="allPlayersBox"></div>
</div>

<div id="tab-bets" class="container hide">
  <h2>Likmes</h2>
  <div id="matchList" class="match-list"></div>
  <h2>RezultÄti</h2>
  <div id="resultList" class="match-list"></div>
</div>

<div id="tab-profile" class="container hide">
  <div class="usercard">
    <div class="row">
      <span class="muted small">Mans ID:</span>
      <span id="meId" class="small">â€”</span>
    </div>
  </div>
</div>

<script type="module" src="firebase.js"></script>
<script type="module">
import { database, getCurrentUser, registerUser, loginUser, logoutUser, getUserBalances,
         getFantasyPlayers, getUserFantasyPlayers, buyFantasyPlayer, removeFantasyPlayer,
         getTeams, updateTeamLogo, updatePlayerStats, getAllUsers, updateUserBalances,
         getMatches, addMatch, placeBet, closeMatchAndPayout } from './firebase.js';

const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const fmt = n => (n||0).toLocaleString('lv-LV');

function showTab(name){
  $('#tab-home').classList.toggle('hide', name!=='home');
  $('#tab-fantasy').classList.toggle('hide', name!=='fantasy');
  $('#tab-bets').classList.toggle('hide', name!=='bets');
  $('#tab-profile').classList.toggle('hide', name!=='profile');
  $$('.tabbtn').forEach(b=> b.classList.toggle('active', b.dataset.tab===name));
}
$$('.tabbtn').forEach(b => b.addEventListener('click', () => {
  showTab(b.dataset.tab);
  if(b.dataset.tab==='fantasy') renderFantasyTab();
  if(b.dataset.tab==='bets') renderBetsTab();
}));

function refreshAuthUI(){
  const u = getCurrentUser();
  $('#btnLogout').classList.toggle('hide', !u);
  $('#userLabel').textContent = u ? u.username : 'viesis';
  const isAdmin = u && u.username==='dturannn';
  $('#adminPanel').classList.toggle('hide', !isAdmin);
}
async function refreshBalances(){
  const u=getCurrentUser(); if(!u) return;
  const b=await getUserBalances(u.id);
  $('#userBalanceBets').textContent = fmt(b.balanceBets);
  $('#userBalanceFantasy').textContent = fmt(b.balanceFantasy);
  $('#meId').textContent = u.id;
}

$('#btnReg').onclick = async () => {
  const u=$('#uName').value.trim(), p=$('#uPass').value.trim();
  if(!u||!p) return alert('LÅ«dzu, ievadi lietotÄjvÄrdu un paroli');
  const ok = await registerUser(u,p);
  if(ok){ refreshAuthUI(); await refreshBalances(); await renderFantasyTab(); }
};
$('#btnLogin').onclick = async () => {
  const u=$('#uName').value.trim(), p=$('#uPass').value.trim();
  const me = await loginUser(u,p);
  if(me){ refreshAuthUI(); await refreshBalances(); await renderFantasyTab(); }
};
$('#btnLogout').onclick = async () => { await logoutUser(); refreshAuthUI(); };

async function renderFantasyTab() {
  const me = getCurrentUser(); if(!me) return;
  const [allPlayers, myPlayers] = await Promise.all([getFantasyPlayers(), getUserFantasyPlayers(me.id)]);
  const myIds = new Set(myPlayers.map(p=>p.id));

  const myBox=$('#myTeamBox'); myBox.innerHTML='';
  myPlayers.slice(0,3).forEach(p => myBox.innerHTML += playerCardHTML(p, true));
  for(let i=myPlayers.length;i<3;i++){ myBox.innerHTML += emptySlotHTML(); }

  const allBox=$('#allPlayersBox'); allBox.innerHTML='';
  allPlayers.forEach(p => {
    const owned = myIds.has(p.id);
    allBox.innerHTML += playerCardHTML(p, owned);
  });

  document.querySelectorAll('.buyBtn').forEach(btn => btn.addEventListener('click', async () => {
    const me = getCurrentUser(); if(!me) return alert('Ielogojies!');
    const ok = await buyFantasyPlayer(me.id, btn.dataset.id);
    if(ok){ await refreshBalances(); renderFantasyTab(); }
  }));
  document.querySelectorAll('.rmBtn').forEach(btn => btn.addEventListener('click', async () => {
    const me = getCurrentUser(); if(!me) return;
    await removeFantasyPlayer(me.id, btn.dataset.id);
    renderFantasyTab();
  }));
}
function playerCardHTML(p, owned){
  const tier = p.tier ?? 3;
  const cost = p.price ?? (tier===1?6:(tier===2?4:2));
  const tierCls = tier===1?'tier-1':(tier===2?'tier-2':'tier-3');
  const logo = p.logo || p.avatar || 'https://picsum.photos/400/220?blur=2';
  const s = {
    premier: p.premierRating ?? 0,
    hltv: p.hltv ?? 0,
    kd: p.kd ?? 0,
    adr: p.adr ?? 0,
    hs: p.hs ?? 0,
    pre3v3: p.pre3v3 ?? 0,
    teamRating: p.teamRating ?? 0,
    points: p.stats?.points ?? 0,
    achievements: p.stats?.achievements ?? ''
  };
  return `<div class="card ${tierCls}">
    <img src="${logo}" alt="${p.name}">
    <div class="title">${p.name}</div>
    <div class="muted small">${p.team}</div>
    <div class="small">Tier ${tier} â€¢ ${cost} kredÄ«ti</div>
    <div class="small">HLTV: ${s.hltv} â€¢ K/D: ${s.kd} â€¢ ADR: ${s.adr} â€¢ HS ${s.hs}%</div>
    <div class="small">Premier: ${s.premier} â€¢ 3v3: ${s.pre3v3} â€¢ Team: ${s.teamRating}</div>
    ${s.achievements ? `<div class="small">${s.achievements}</div>` : ''}
    ${owned 
      ? `<div class="badge">SastÄvÄ</div> <button class="rmBtn" data-id="${p.id}">âœ–</button>`
      : `<button class="buyBtn" data-id="${p.id}">Pirkt</button>`}
  </div>`;
}
function emptySlotHTML(){
  return `<div class="card" style="opacity:.6; text-align:center;">
    <div class="title">TukÅ¡a vieta</div>
    <div class="muted small">Pievieno spÄ“lÄ“tÄju no saraksta</div>
  </div>`;
}

// Bets UI
async function renderBetsTab(){
  const { open, closed } = await getMatches();
  const list = $('#matchList'); const res = $('#resultList');
  list.innerHTML=''; res.innerHTML='';

  open.forEach(m => list.appendChild(matchCard(m, false)));
  closed.forEach(m => res.appendChild(matchCard(m, true)));

  // Admin add match
  $('#mAdd')?.addEventListener('click', async () => {
    const team1 = $('#mTeam1').value.trim();
    const team2 = $('#mTeam2').value.trim();
    const tournament = $('#mTournament').value.trim();
    const time = $('#mTime').value.trim();
    if(!team1||!team2) return alert('Komandas?');
    await addMatch({ team1, team2, tournament, time });
    renderBetsTab();
  });
}

function matchCard(m, closed){
  const wrap = document.createElement('div');
  wrap.className = 'match-card';
  wrap.innerHTML = `
    <div class="match-head">
      <div class="team"><img class="logo" src="${m.logo1||'https://picsum.photos/seed/t1/64/64'}"><b>${m.team1}</b></div>
      <span class="vs">vs</span>
      <div class="team"><img class="logo" src="${m.logo2||'https://picsum.photos/seed/t2/64/64'}"><b>${m.team2}</b></div>
    </div>
    <div class="kicker">${m.tournament||'TurnÄ«rs'} â€¢ ${m.time||''}</div>
    <hr>
    <div class="match-actions"></div>
  `;
  const actions = wrap.querySelector('.match-actions');
  if(!closed){
    actions.innerHTML = `
      <select class="pick">
        <option value="team1">${m.team1}</option>
        <option value="team2">${m.team2}</option>
      </select>
      <input class="amt" type="number" min="1" value="1" style="width:90px" placeholder="Summa">
      <button class="betBtn">LikmÄ“t</button>
      <span class="note">Min 1 kredÄ«ts. Banka tiek dalÄ«ta starp uzvarÄ“tÄjiem, 7.5% adminam.</span>
    `;
    actions.querySelector('.betBtn').addEventListener('click', async () => {
      const me = getCurrentUser(); if(!me) return alert('Ielogojies!');
      const team = actions.querySelector('.pick').value;
      const amt = Math.max(1, Math.floor(parseFloat(actions.querySelector('.amt').value)||0));
      const ok = await placeBet(me.id, m.id, team, amt);
      if(ok){ alert('Likme pieÅ†emta'); await refreshBalances(); }
      else { alert('Likmi nevarÄ“ja pieÅ†emt'); }
    });

    const u = getCurrentUser(); const isAdmin = u && u.username==='dturannn';
    if(isAdmin){
      const adminRow = document.createElement('div');
      adminRow.className='row'; adminRow.style.marginTop='8px';
      adminRow.innerHTML = `
        <select class="winPick">
          <option value="team1">${m.team1}</option>
          <option value="team2">${m.team2}</option>
        </select>
        <button class="closeBtn">AizvÄ“rt spÄ“li</button>
      `;
      actions.appendChild(adminRow);
      adminRow.querySelector('.closeBtn').addEventListener('click', async () => {
        const w = adminRow.querySelector('.winPick').value;
        await closeMatchAndPayout(m.id, w);
        alert('SpÄ“le aizvÄ“rta, laimesti sadalÄ«ti');
        renderBetsTab(); await refreshBalances();
      });
    }
  } else {
    const winnerName = m.winner==='team1'? m.team1 : (m.winner==='team2'? m.team2 : 'â€”');
    actions.innerHTML = `<span class="badge">UzvarÄ“tÄjs: ${winnerName}</span> <span class="small">Banka: ${fmt(m.pool||0)} â€¢ Admin: ${fmt(m.adminCut||0)}</span>`;
  }
  return wrap;
}

// Users list (admin)
async function renderUsersList(){
  const list = await getAllUsers();
  const box = $('#usersList'); box.innerHTML = '';
  list.forEach(u => {
    const bets = u.balances?.balanceBets ?? 0;
    const fan = u.balances?.balanceFantasy ?? 0;
    const id = u.id;
    box.innerHTML += `<div class="card">
      <div><b>${u.username}</b> <span class="muted small">(${id})</span></div>
      <div class="row" style="margin-top:6px">
        <label class="small">Likmes: <input id="bets-${id}" type="number" value="${bets}"></label>
        <label class="small">Fantasy: <input id="fan-${id}" type="number" value="${fan}"></label>
        <button class="saveUserBtn" data-id="${id}">ğŸ’¾ SaglabÄt</button>
      </div>
    </div>`;
  });
  document.querySelectorAll('.saveUserBtn').forEach(btn => btn.addEventListener('click', async () => {
    const id = btn.dataset.id;
    const newBets = parseFloat(document.querySelector('#bets-'+id).value)||0;
    const newFan  = parseFloat(document.querySelector('#fan-'+id).value)||0;
    await updateUserBalances(id, { balanceBets: newBets, balanceFantasy: newFan });
    alert('Bilance atjaunota');
    await refreshBalances();
  }));
}
$('#refreshUsersList').addEventListener('click', renderUsersList);

refreshAuthUI();
</script>
</body>
</html>
